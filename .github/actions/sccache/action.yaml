---
name: "sccache"
description: "Configure sccache caching"
inputs:
  bucket:
    description: S3 bucket to use for caching
    required: true
  region:
    description: S3 bucket region
    required: true
  endpoint:
    description: S3 endpoint to use for caching
    required: true
  access_key_id:
    description: S3 endpoint access key ID
    required: true
  secret_access_key:
    description: S3 endpoint secret access key
    required: true
  install:
    description: "Install sccache"
    default: "true"

# TODO: Cache deps here to save 1 minute
runs:
  using: composite
  steps:
    - name: Install sccache binary
      if: ${{ inputs.install == 'true' }}
      uses: mozilla-actions/sccache-action@v0.0.6
      with:
        version: "v0.8.2" # Must be the same as in Dockerfile

    - name: Configure AWS credentials
      uses: ./.github/actions/aws_credentials
      with:
        access_key_id: ${{ inputs.access_key_id }}
        secret_access_key: ${{ inputs.secret_access_key }}
        profile: "sccache"

    - name: Configure sccache
      shell: bash
      run: |
        echo "CARGO_INCREMENTAL=0" >> $GITHUB_ENV
        echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
        echo "SCCACHE_BUCKET=${{ inputs.bucket }}" >> $GITHUB_ENV
        echo "SCCACHE_REGION=${{ inputs.region }}" >> $GITHUB_ENV
        echo "SCCACHE_ENDPOINT=${{ inputs.endpoint }}" >> $GITHUB_ENV
        echo "SCCACHE_S3_KEY_PREFIX=${{ runner.os }}/sccache/${{ runner.arch }}/linux-gnu" >> $GITHUB_ENV
