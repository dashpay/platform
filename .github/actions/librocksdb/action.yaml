---
name: "librocksdb"
description: "Build and install librocksdb"
inputs:
  runs-on:
    description: Target platform
    required: false
    default: linux-24.04

  version:
    description: RocksDB version, eg. "8.10.2"
    required: false
    default: "8.10.2"
runs:
  using: composite
  steps:
    - name: Load cached librocksdb
      id: librocksdb-cache
      uses: actions/cache@v3
      with:
        path: /opt/rocksdb
        key: librocksdb-${{ runner.os }}-${{ inputs.version }}

    - if: ${{ steps.librocksdb-cache.outputs.cache-hit != 'true' }}
      shell: bash
      name: Build librocksdb
      run: |
        set -ex
        WORKDIR=/tmp/rocksdb-build
        mkdir -p ${WORKDIR}/rocksdb
        mkdir -p /opt/rocksdb/usr/local/lib/
        pushd ${WORKDIR}/rocksdb

        # building rocksdb
        [[ -d .git ]] || git clone https://github.com/facebook/rocksdb.git -b v${{ inputs.version }} --depth 1 .
        make -j$(nproc) static_lib
        make DESTDIR=/opt/rocksdb install-static
        set +x

        echo Done.
        echo Configuration:
        echo
        echo "ROCKSDB_STATIC='/opt/rocksdb/usr/local/lib/librocksdb.a'"
        echo "ROCKSDB_LIB_DIR='/opt/rocksdb/usr/local/lib'"

        popd
