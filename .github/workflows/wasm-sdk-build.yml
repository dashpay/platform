name: Build and Test WASM SDK

on:
  pull_request:
    paths:
      - 'packages/wasm-sdk/**'
      - 'packages/rs-sdk/**'
      - 'packages/rs-drive-proof-verifier/**'
      - 'packages/rs-platform-value/**'
      - 'packages/rs-dpp/**'
      - 'packages/rs-drive/src/verify/**'
      - 'packages/rs-context-provider/**'
  push:
    branches:
      - main
      - master
      - 'v[0-9]+.[0-9]+-dev'
      - 'v[0-9]+.[0-9]+-dev-sdk'
    paths:
      - 'packages/wasm-sdk/**'
      - 'packages/rs-sdk/**'
      - 'packages/rs-drive-proof-verifier/**'
      - 'packages/rs-platform-value/**'
      - 'packages/rs-dpp/**'
      - 'packages/rs-drive/src/verify/**'
      - 'packages/rs-context-provider/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-C lto=off"
  CARGO_PROFILE_RELEASE_LTO: false
  CI: true

jobs:
  build-wasm-sdk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache and install protoc (v32.0)
        uses: actions/cache@v4
        id: cache-protoc
        with:
          path: |
            ${{ env.HOME }}/.local/protoc-32.0/bin
            ${{ env.HOME }}/.local/protoc-32.0/include
          key: protoc/32.0/${{ runner.os }}/x86_64

      - name: Install protoc v32.0 if cache miss
        if: steps.cache-protoc.outputs.cache-hit != 'true'
        run: |
          set -euxo pipefail
          PROTOC_DIR="${HOME}/.local/protoc-32.0"
          mkdir -p "$PROTOC_DIR"
          curl -fsSL -o /tmp/protoc.zip \
            "https://github.com/protocolbuffers/protobuf/releases/download/v32.0/protoc-32.0-linux-x86_64.zip"
          unzip -o /tmp/protoc.zip -d "$PROTOC_DIR"

      - name: Save cached protoc v32.0
        if: steps.cache-protoc.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.HOME }}/.local/protoc-32.0/bin
            ${{ env.HOME }}/.local/protoc-32.0/include
          key: protoc/32.0/${{ runner.os }}/x86_64

      - name: Export protoc v32.0 to PATH
        run: |
          echo "${HOME}/.local/protoc-32.0/bin" >> $GITHUB_PATH
          echo "PROTOC=${HOME}/.local/protoc-32.0/bin/protoc" >> $GITHUB_ENV

      - name: Install clang and llvm
        run: |
          sudo apt update -qq
          sudo apt install -qq --yes clang llvm

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-wasm-sdk-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-wasm-sdk-

      - name: Install wasm-pack
        run: |
          if ! command -v wasm-pack &> /dev/null; then
            echo "Installing wasm-pack..."
            curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
          else
            echo "wasm-pack already installed"
          fi

      - name: Cache and install wasm-opt (Binaryen)
        uses: actions/cache@v4
        id: cache-binaryen
        with:
          path: ${{ env.HOME }}/.cache/binaryen/version_121
          key: binaryen/version_121/${{ runner.os }}/x86_64

      - name: Install wasm-opt if cache miss
        if: steps.cache-binaryen.outputs.cache-hit != 'true'
        run: |
          set -euxo pipefail
          mkdir -p "${HOME}/.cache/binaryen"
          curl -fsSL -o /tmp/binaryen.tar.gz \
            "https://github.com/WebAssembly/binaryen/releases/download/version_121/binaryen-version_121-x86_64-linux.tar.gz"
          tar -xzf /tmp/binaryen.tar.gz -C "${HOME}/.cache/binaryen"
          mv "${HOME}/.cache/binaryen/binaryen-version_121" "${HOME}/.cache/binaryen/version_121"

      - name: Save cached wasm-opt
        if: steps.cache-binaryen.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ${{ env.HOME }}/.cache/binaryen/version_121
          key: binaryen/version_121/${{ runner.os }}/x86_64

      - name: Export wasm-opt to PATH
        run: |
          echo "${HOME}/.cache/binaryen/version_121/bin" >> $GITHUB_PATH

      - name: Build WASM SDK
        working-directory: packages/wasm-sdk
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Verify build output
        working-directory: packages/wasm-sdk
        run: |
          echo "Checking build output..."
          ls -lah pkg/
          # Verify required files exist
          test -f pkg/dash_wasm_sdk_bg.wasm
          test -f pkg/optimized.wasm
          test -f pkg/dash_wasm_sdk.js
          test -f pkg/dash_wasm_sdk.d.ts
          test -f pkg/package.json
          echo "Build verification successful!"

      - name: Measure and track bundle sizes
        working-directory: packages/wasm-sdk
        run: |
          echo "ðŸ“¦ Bundle Size Analysis" | tee bundle-sizes.txt
          echo "=========================" | tee -a bundle-sizes.txt
          echo "" | tee -a bundle-sizes.txt
          
          # Measure unoptimized WASM size
          if [ -f pkg/dash_wasm_sdk_bg.wasm ]; then
            UNOPT_SIZE=$(wc -c < pkg/dash_wasm_sdk_bg.wasm)
            UNOPT_SIZE_MB=$(echo "scale=2; $UNOPT_SIZE / 1024 / 1024" | bc)
            echo "ðŸ”§ Unoptimized WASM: ${UNOPT_SIZE} bytes (${UNOPT_SIZE_MB} MB)" | tee -a bundle-sizes.txt
          fi
          
          # Measure optimized WASM size  
          if [ -f pkg/optimized.wasm ]; then
            OPT_SIZE=$(wc -c < pkg/optimized.wasm)
            OPT_SIZE_MB=$(echo "scale=2; $OPT_SIZE / 1024 / 1024" | bc)
            echo "âš¡ Optimized WASM: ${OPT_SIZE} bytes (${OPT_SIZE_MB} MB)" | tee -a bundle-sizes.txt
            
            # Calculate optimization savings
            if [ -n "$UNOPT_SIZE" ]; then
              SAVINGS=$((UNOPT_SIZE - OPT_SIZE))
              SAVINGS_PCT=$(echo "scale=1; $SAVINGS * 100 / $UNOPT_SIZE" | bc)
              echo "ðŸ’¾ Optimization savings: ${SAVINGS} bytes (${SAVINGS_PCT}%)" | tee -a bundle-sizes.txt
            fi
          fi
          
          # Measure JavaScript bindings
          if [ -f pkg/dash_wasm_sdk.js ]; then
            JS_SIZE=$(wc -c < pkg/dash_wasm_sdk.js)
            JS_SIZE_KB=$(echo "scale=1; $JS_SIZE / 1024" | bc)
            echo "ðŸ“„ JavaScript bindings: ${JS_SIZE} bytes (${JS_SIZE_KB} KB)" | tee -a bundle-sizes.txt
          fi
          
          # Measure TypeScript definitions
          if [ -f pkg/dash_wasm_sdk.d.ts ]; then
            TS_SIZE=$(wc -c < pkg/dash_wasm_sdk.d.ts)
            TS_SIZE_KB=$(echo "scale=1; $TS_SIZE / 1024" | bc)
            echo "ðŸ“ TypeScript definitions: ${TS_SIZE} bytes (${TS_SIZE_KB} KB)" | tee -a bundle-sizes.txt
          fi
          
          # Calculate total package size
          TOTAL_SIZE=$(find pkg/ -type f -exec wc -c {} + | tail -1 | awk '{print $1}')
          TOTAL_SIZE_MB=$(echo "scale=2; $TOTAL_SIZE / 1024 / 1024" | bc)
          echo "" | tee -a bundle-sizes.txt
          echo "ðŸ“¦ Total package size: ${TOTAL_SIZE} bytes (${TOTAL_SIZE_MB} MB)" | tee -a bundle-sizes.txt
          
          # Add size thresholds and warnings
          echo "" | tee -a bundle-sizes.txt
          echo "ðŸš¨ Size Thresholds:" | tee -a bundle-sizes.txt
          
          # Warn if optimized WASM exceeds 10MB
          if [ -n "$OPT_SIZE" ] && [ "$OPT_SIZE" -gt 10485760 ]; then
            echo "âš ï¸  WARNING: Optimized WASM exceeds 10MB (${OPT_SIZE_MB} MB)" | tee -a bundle-sizes.txt
          else
            echo "âœ… Optimized WASM size acceptable (< 10MB)" | tee -a bundle-sizes.txt
          fi
          
          # Warn if total package exceeds 15MB
          if [ "$TOTAL_SIZE" -gt 15728640 ]; then
            echo "âš ï¸  WARNING: Total package exceeds 15MB (${TOTAL_SIZE_MB} MB)" | tee -a bundle-sizes.txt
          else
            echo "âœ… Total package size acceptable (< 15MB)" | tee -a bundle-sizes.txt
          fi
          
          echo "" | tee -a bundle-sizes.txt
          echo "Bundle size analysis complete!" | tee -a bundle-sizes.txt

      - name: Add bundle size to job summary
        if: always()
        working-directory: packages/wasm-sdk
        run: |
          echo "## ðŸ“¦ Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f bundle-sizes.txt ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat bundle-sizes.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Add download links for size tracking
            echo "ðŸ“Š **Size tracking**: Bundle size data available in build artifacts" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Bundle size data not available" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload bundle size data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bundle-size-report
          path: packages/wasm-sdk/bundle-sizes.txt
          retention-days: 30

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-sdk-build
          path: packages/wasm-sdk/pkg/
          retention-days: 7

  test-wasm-sdk:
    runs-on: ubuntu-latest
    needs: build-wasm-sdk

    steps:
      - name: Checkout test directory only
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            packages/wasm-sdk/test
          sparse-checkout-cone-mode: false

      - name: Download WASM SDK build artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-sdk-build
          path: packages/wasm-sdk/pkg/

      - name: Verify WASM SDK artifacts
        working-directory: packages/wasm-sdk
        run: |
          echo "Verifying downloaded WASM SDK artifacts..."
          ls -lah pkg/

          # Verify all required files exist
          required_files=(
            "pkg/dash_wasm_sdk_bg.wasm"
            "pkg/optimized.wasm"
            "pkg/dash_wasm_sdk.js"
            "pkg/dash_wasm_sdk.d.ts"
            "pkg/package.json"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing required file: $file"
              exit 1
            else
              echo "âœ… Found: $file"
            fi
          done

          echo "ðŸŽ‰ All WASM SDK artifacts verified successfully!"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install test dependencies
        working-directory: packages/wasm-sdk/test
        run: |
          if [ -f package.json ]; then
            npm install
          fi

      - name: Run comprehensive test suite
        working-directory: packages/wasm-sdk
        run: |
          echo "Running WASM SDK comprehensive test suite..."
          node test/run-all-tests.mjs | tee test-output.log

      - name: Generate job summary
        if: always()
        working-directory: packages/wasm-sdk
        run: |
          echo "## ðŸ§ª WASM SDK Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract test results from the test output
          if [ -f test-output.log ]; then
            # Extract overall summary
            total_tests=$(grep -o "Total Tests: [0-9]*" test-output.log | grep -o "[0-9]*" || echo "0")
            total_passed=$(grep -o "Passed: [0-9]*" test-output.log | grep -o "[0-9]*" || echo "0")
            total_failed=$(grep -o "Failed: [0-9]*" test-output.log | grep -o "[0-9]*" || echo "0")
            total_time=$(grep -o "Time: [0-9]*\.[0-9]*s" test-output.log | grep -o "[0-9]*\.[0-9]*" || echo "0.00")

            # Display overall summary
            echo "**$total_tests** tests â€¢ **$total_passed** passed â€¢ **$total_failed** failed â€¢ **${total_time}s**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$total_failed" != "0" ]; then
              echo "âŒ **Some tests failed** - Check the detailed test report for specifics" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **All tests passed**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No test output captured" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Artifacts**: WASM SDK build files and detailed test report available for download" >> $GITHUB_STEP_SUMMARY

      - name: Upload test report
        if: always() && hashFiles('packages/wasm-sdk/test/test-report.html') != ''
        uses: actions/upload-artifact@v4
        with:
          name: wasm-sdk-test-report
          path: packages/wasm-sdk/test/test-report.html
          retention-days: 7
