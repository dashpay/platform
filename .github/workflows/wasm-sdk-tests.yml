name: WASM SDK Tests

on:
  # Trigger after Build WASM SDK workflow completes successfully
  workflow_run:
    workflows: ["Build WASM SDK"]
    types:
      - completed
    # branches:
    #   - main
    #   - master
    #   - 'v[0-9]+.[0-9]+-dev'
    #   - 'v[0-9]+.[0-9]+-dev-sdk'
  
  # Manual trigger for standalone testing
  workflow_dispatch:
    inputs:
      workflow_run_id:
        description: 'Workflow run ID to download WASM SDK build from (for manual runs)'
        required: false
        type: string

env:
  CI: true

jobs:
  test-wasm-sdk:
    runs-on: ubuntu-latest
    # Only run if build workflow succeeded (for workflow_run) or if manually triggered
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
        
      - name: Download WASM SDK build artifacts
        uses: actions/download-artifact@v4
        with:
          # For workflow_run, download from the triggering workflow
          # For manual dispatch, use provided workflow_run_id or latest
          run-id: ${{ github.event.workflow_run.id || inputs.workflow_run_id }}
          name: wasm-sdk-build
          path: packages/wasm-sdk/pkg/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Verify WASM SDK artifacts
        working-directory: packages/wasm-sdk
        run: |
          echo "Verifying downloaded WASM SDK artifacts..."
          ls -lah pkg/
          
          # Verify all required files exist
          required_files=(
            "pkg/wasm_sdk_bg.wasm"
            "pkg/optimized.wasm" 
            "pkg/wasm_sdk.js"
            "pkg/wasm_sdk.d.ts"
            "pkg/package.json"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Missing required file: $file"
              exit 1
            else
              echo "‚úÖ Found: $file"
            fi
          done
          
          echo "üéâ All WASM SDK artifacts verified successfully!"
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install test dependencies
        working-directory: packages/wasm-sdk/test
        run: |
          if [ -f package.json ]; then
            npm install
          fi
          
      - name: Run comprehensive test suite
        working-directory: packages/wasm-sdk
        run: |
          echo "Running WASM SDK comprehensive test suite..."
          node test/run-all-tests.mjs
          
      - name: Upload test report
        if: always() && hashFiles('packages/wasm-sdk/test/test-report.html') != ''
        uses: actions/upload-artifact@v4
        with:
          name: wasm-sdk-test-report
          path: packages/wasm-sdk/test/test-report.html
          retention-days: 7
