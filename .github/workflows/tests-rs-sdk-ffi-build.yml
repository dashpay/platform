name: Test rs-sdk-ffi build

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'packages/rs-sdk-ffi/**'
      - 'packages/rs-sdk/**'
      - '.github/workflows/tests-rs-sdk-ffi-build.yml'
  push:
    branches:
      - master
      - 'v[0-9]+\.[0-9]+-dev'
    paths:
      - 'packages/rs-sdk-ffi/**'
      - 'packages/rs-sdk/**'
      - '.github/workflows/tests-rs-sdk-ffi-build.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-ffi-cross-compile:
    name: Build FFI for Apple target
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/rust
        with:
          target: aarch64-apple-darwin

      - name: Install cross-compilation dependencies
        run: |
          # Install osxcross or other cross-compilation tools if needed
          # For now, we'll just add the target
          rustup target add aarch64-apple-darwin

      - name: Build FFI library for Apple target
        working-directory: packages/rs-sdk-ffi
        env:
          # Set up cross-compilation environment variables if needed
          CARGO_TARGET_AARCH64_APPLE_DARWIN_LINKER: rust-lld
        run: |
          cargo build --release --target aarch64-apple-darwin

      - name: Verify build output
        run: |
          if [ ! -f "target/aarch64-apple-darwin/release/librs_sdk_ffi.a" ]; then
            echo "Error: FFI library was not built for Apple target"
            exit 1
          fi
          echo "FFI library successfully built for Apple target"
          ls -la target/aarch64-apple-darwin/release/librs_sdk_ffi.a