<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Check Identity Keys</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        #result {
            margin-top: 20px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
        .key-info {
            margin: 10px 0;
            padding: 10px;
            background-color: #e8f4f8;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Check Identity Keys</h1>
    
    <div class="form-group">
        <label>Identity ID:</label>
        <input type="text" id="identityId" value="5DbLwAxGBzUzo81VewMUwn4b5P4bpv9FNFybi25XB5Bk">
    </div>
    
    <div class="form-group">
        <label>Private Key (WIF):</label>
        <input type="password" id="privateKey" value="XK6CFyvYUMvY9FVQLeYBZBFDbC4QuBLiqWMAFxBVZcMHJ5eARJtf">
    </div>
    
    <button onclick="checkKeys()">Check Keys</button>
    <button onclick="fetchIdentity()">Fetch Identity Only</button>
    
    <div id="result"></div>

    <script type="module">
        import init, { WasmSdkBuilder } from './pkg/wasm_sdk.js';
        
        let sdk = null;
        
        async function initSDK() {
            await init();
            const builder = new WasmSdkBuilder();
            builder.set_testnet_mode();
            sdk = builder.build();
            window.sdk = sdk;
            console.log('SDK initialized');
        }
        
        window.fetchIdentity = async function() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Fetching identity...';
            resultDiv.className = '';
            
            try {
                const identityId = document.getElementById('identityId').value;
                
                // Fetch the identity
                const identity = await sdk.identityGet(identityId);
                
                if (!identity) {
                    resultDiv.innerHTML = 'Identity not found';
                    resultDiv.className = 'error';
                    return;
                }
                
                resultDiv.innerHTML = 'Identity found!\n\n';
                resultDiv.innerHTML += 'ID: ' + identity.id + '\n';
                resultDiv.innerHTML += 'Balance: ' + identity.balance + '\n';
                resultDiv.innerHTML += 'Revision: ' + identity.revision + '\n\n';
                
                resultDiv.innerHTML += 'Public Keys:\n';
                if (identity.publicKeys && identity.publicKeys.length > 0) {
                    identity.publicKeys.forEach((key, index) => {
                        resultDiv.innerHTML += `\nKey ${index + 1}:\n`;
                        resultDiv.innerHTML += `  ID: ${key.id}\n`;
                        resultDiv.innerHTML += `  Type: ${key.type}\n`;
                        resultDiv.innerHTML += `  Purpose: ${key.purpose}\n`;
                        resultDiv.innerHTML += `  Security Level: ${key.securityLevel}\n`;
                        resultDiv.innerHTML += `  Data: ${key.data}\n`;
                        resultDiv.innerHTML += `  Disabled: ${key.disabledAt ? 'Yes' : 'No'}\n`;
                    });
                } else {
                    resultDiv.innerHTML += '  No public keys found\n';
                }
                
            } catch (error) {
                console.error('Error:', error);
                resultDiv.innerHTML = 'Error: ' + (error.message || error);
                resultDiv.className = 'error';
            }
        };
        
        window.checkKeys = async function() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Checking keys...';
            resultDiv.className = '';
            
            try {
                const identityId = document.getElementById('identityId').value;
                const privateKeyWif = document.getElementById('privateKey').value;
                
                // First, derive the public key from the private key
                resultDiv.innerHTML += '\n1. Deriving public key from private key...\n';
                
                // We'll need to use a library or manual conversion here
                // For now, let's fetch the identity and show all keys
                
                const identity = await sdk.identityGet(identityId);
                
                if (!identity) {
                    resultDiv.innerHTML = 'Identity not found';
                    resultDiv.className = 'error';
                    return;
                }
                
                resultDiv.innerHTML += '\n2. Identity fetched successfully\n';
                resultDiv.innerHTML += '\n3. Authentication Keys in Identity:\n';
                
                let authKeyCount = 0;
                if (identity.publicKeys && identity.publicKeys.length > 0) {
                    identity.publicKeys.forEach((key, index) => {
                        if (key.purpose === 0) { // AUTHENTICATION = 0
                            authKeyCount++;
                            resultDiv.innerHTML += `\nAuthentication Key ${authKeyCount}:\n`;
                            resultDiv.innerHTML += `  Key ID: ${key.id}\n`;
                            resultDiv.innerHTML += `  Type: ${key.type} (0=ECDSA_SECP256K1, 1=BLS12_381, 2=ECDSA_HASH160, 3=BIP13_SCRIPT_HASH, 4=EDDSA_25519_HASH160)\n`;
                            resultDiv.innerHTML += `  Security Level: ${key.securityLevel}\n`;
                            resultDiv.innerHTML += `  Public Key Data: ${key.data}\n`;
                            resultDiv.innerHTML += `  Disabled: ${key.disabledAt ? 'Yes at ' + key.disabledAt : 'No'}\n`;
                        }
                    });
                    
                    if (authKeyCount === 0) {
                        resultDiv.innerHTML += '\n  No authentication keys found!\n';
                    }
                } else {
                    resultDiv.innerHTML += '\n  No public keys found in identity!\n';
                }
                
                resultDiv.innerHTML += '\n\n4. Summary:\n';
                resultDiv.innerHTML += `Total keys: ${identity.publicKeys ? identity.publicKeys.length : 0}\n`;
                resultDiv.innerHTML += `Authentication keys: ${authKeyCount}\n`;
                
                resultDiv.innerHTML += '\n\n5. Next Steps:\n';
                resultDiv.innerHTML += '- Make sure your private key corresponds to one of the authentication keys above\n';
                resultDiv.innerHTML += '- The public key data should match what\'s derived from your private key\n';
                resultDiv.innerHTML += '- If no authentication keys exist, you may need to add one to your identity\n';
                
            } catch (error) {
                console.error('Error:', error);
                resultDiv.innerHTML = 'Error: ' + (error.message || error);
                resultDiv.className = 'error';
            }
        };
        
        // Initialize on load
        initSDK().catch(console.error);
    </script>
</body>
</html>