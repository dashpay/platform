# GitLab CI configuration for WASM SDK

stages:
  - lint
  - test
  - build
  - deploy

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  RUSTUP_HOME: $CI_PROJECT_DIR/.rustup

cache:
  paths:
    - .cargo/
    - .rustup/
    - target/

before_script:
  - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  - source $CARGO_HOME/env
  - rustup target add wasm32-unknown-unknown
  - curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

# Lint stage
lint:cargo-fmt:
  stage: lint
  script:
    - rustup component add rustfmt
    - cargo fmt --all -- --check
  only:
    - merge_requests
    - main
    - develop

lint:clippy:
  stage: lint
  script:
    - rustup component add clippy
    - cargo clippy --workspace --all-features -- -D warnings
  only:
    - merge_requests
    - main
    - develop

# Test stage
test:unit:
  stage: test
  script:
    - cargo test --workspace --lib
  only:
    - merge_requests
    - main
    - develop

test:integration:
  stage: test
  script:
    - cargo test --workspace --test '*'
  only:
    - merge_requests
    - main
    - develop

test:wasm:
  stage: test
  image: mcr.microsoft.com/playwright:v1.40.0-focal
  script:
    - wasm-pack test --chrome --headless
  only:
    - merge_requests
    - main
    - develop

# Build stage
build:dev:
  stage: build
  script:
    - wasm-pack build --target web --out-dir pkg --dev
  artifacts:
    paths:
      - pkg/
    expire_in: 1 week
  only:
    - develop

build:release:
  stage: build
  script:
    - wasm-pack build --target web --out-dir pkg --release
    - |
      if command -v wasm-opt >/dev/null 2>&1; then
        wasm-opt -Oz -o pkg/wasm_sdk_bg_optimized.wasm pkg/wasm_sdk_bg.wasm
      fi
  artifacts:
    paths:
      - pkg/
    expire_in: 1 month
  only:
    - main
    - tags

# Deploy stage
deploy:docs:
  stage: deploy
  script:
    - cargo doc --workspace --no-deps --all-features
    - cp -r target/doc public
  artifacts:
    paths:
      - public
  only:
    - main

deploy:npm:
  stage: deploy
  script:
    - wasm-pack build --target bundler --out-dir pkg --release
    - cd pkg
    - npm config set //registry.npmjs.org/:_authToken ${NPM_TOKEN}
    - npm publish --access public
  only:
    - tags