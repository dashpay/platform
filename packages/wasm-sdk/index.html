<!DOCTYPE html>
<html>

<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    #preloader {
      display: none;
    }

    .container {
      padding: 10px;
    }

    .network-toggle {
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .network-toggle label {
      margin-right: 15px;
      font-weight: bold;
    }

    .network-indicator {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 3px;
      margin-left: 10px;
      font-size: 0.9em;
      font-weight: bold;
    }

    .network-indicator.testnet {
      background-color: #ff9800;
      color: white;
    }

    .network-indicator.mainnet {
      background-color: #4caf50;
      color: white;
    }

    .status-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 15px;
      text-align: center;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .status-banner.success {
      background-color: #4caf50;
      color: white;
    }

    .status-banner.error {
      background-color: #f44336;
      color: white;
    }

    .status-banner.loading {
      background-color: #ff9800;
      color: white;
    }
  </style>
</head>

<body>
  <div id="preloader">Loading...</div>
  
  <div class="network-toggle">
    <label>Network:</label>
    <input type="radio" id="mainnet" name="network" value="mainnet" checked>
    <label for="mainnet">Mainnet</label>
    <input type="radio" id="testnet" name="network" value="testnet">
    <label for="testnet">Testnet</label>
    <span id="networkIndicator" class="network-indicator mainnet">MAINNET</span>
    <br>
    <label style="margin-top: 5px;">
      <input type="checkbox" id="trustedMode" style="margin-right: 5px;">
      Use Trusted Mode (fetches quorum info from HTTP endpoints)
    </label>
  </div>

  <div class="container">
    <input type="text" id="identityInput" placeholder="Enter Identity ID" />
    <button id="fetchButton">Fetch Identity</button>
  </div>

  <div class="container">
    <input type="text" id="identityInput2" placeholder="Enter Data Contract ID" />
    <button id="fetchButton2">Fetch Data Contract</button>
  </div>
  <div id="identityInfo"></div>

  <div id="statusBanner" class="status-banner loading">Initializing WASM SDK...</div>

  <script type="module">
    import init, { start, WasmSdkBuilder, identity_fetch, data_contract_fetch } from './pkg/wasm_sdk.js';

    let sdk = null;

    function updateStatus(message, type = 'loading') {
      const statusBanner = document.getElementById('statusBanner');
      statusBanner.textContent = message;
      statusBanner.className = `status-banner ${type}`;
    }

    async function initializeSdk(network) {
      const preloader = document.getElementById('preloader');
      preloader.style.display = 'block';
      const useTrusted = document.getElementById('trustedMode').checked;
      const modeStr = useTrusted ? 'trusted' : 'standard';
      updateStatus(`Initializing ${network.toUpperCase()} SDK (${modeStr} mode)...`, 'loading');
      
      try {
        if (useTrusted) {
          if (network === 'mainnet') {
            sdk = await WasmSdkBuilder.new_mainnet_trusted().build();
          } else {
            sdk = await WasmSdkBuilder.new_testnet_trusted().build();
          }
        } else {
          if (network === 'mainnet') {
            sdk = await WasmSdkBuilder.new_mainnet().build();
          } else {
            sdk = await WasmSdkBuilder.new_testnet().build();
          }
        }
        console.log(`Initialized ${network} SDK (${modeStr} mode):`, sdk);
        updateStatus(`WASM SDK successfully loaded on ${network.toUpperCase()} (${modeStr} mode)`, 'success');
      } catch (error) {
        console.error(`Error initializing ${network} SDK:`, error);
        document.getElementById('identityInfo').textContent = `Error initializing ${network} SDK: ${error}`;
        updateStatus(`Error loading WASM SDK: ${error.message || error}`, 'error');
      } finally {
        preloader.style.display = 'none';
      }
    }

    async function run() {
      try {
        updateStatus('Loading WASM module...', 'loading');
        await init();
        updateStatus('WASM module loaded, initializing SDK...', 'loading');
        
        // Initialize with mainnet by default
        await initializeSdk('mainnet');
      } catch (error) {
        console.error('Failed to initialize WASM:', error);
        updateStatus(`Failed to load WASM module: ${error.message || error}`, 'error');
      }

      // Handle network toggle
      document.querySelectorAll('input[name="network"]').forEach(radio => {
        radio.addEventListener('change', async (event) => {
          const network = event.target.value;
          const indicator = document.getElementById('networkIndicator');
          
          // Update indicator
          indicator.textContent = network.toUpperCase();
          indicator.className = `network-indicator ${network}`;
          
          // Clear any existing results
          document.getElementById('identityInfo').textContent = '';
          
          // Reinitialize SDK with new network
          await initializeSdk(network);
        });
      });

      // Handle trusted mode toggle
      document.getElementById('trustedMode').addEventListener('change', async () => {
        // Get current network selection
        const network = document.querySelector('input[name="network"]:checked').value;
        
        // Clear any existing results
        document.getElementById('identityInfo').textContent = '';
        
        // Reinitialize SDK with current network and new trusted mode
        await initializeSdk(network);
      });

      document.getElementById('fetchButton').addEventListener('click', async () => {
        if (!sdk) {
          alert('SDK not initialized. Please wait or refresh the page.');
          return;
        }

        const identityId = document.getElementById('identityInput').value;
        const preloader = document.getElementById('preloader');
        const identityInfo = document.getElementById('identityInfo');

        preloader.style.display = 'block';
        identityInfo.textContent = '';

        try {
          const identity = await identity_fetch(sdk, identityId);
          console.log("fetched identity");
          console.log(identity);
          identityInfo.textContent = JSON.stringify(identity.toJSON(), null, 2);
        } catch (error) {
          console.error("Error fetching identity:", error);
          identityInfo.textContent = `Error fetching identity: ${error}`;
        } finally {
          preloader.style.display = 'none';
        }
      });

      document.getElementById('fetchButton2').addEventListener('click', async () => {
        if (!sdk) {
          alert('SDK not initialized. Please wait or refresh the page.');
          return;
        }

        const identityId = document.getElementById('identityInput2').value;
        const preloader = document.getElementById('preloader');
        const identityInfo = document.getElementById('identityInfo');

        preloader.style.display = 'block';
        identityInfo.textContent = '';

        try {
          const dataContract = await data_contract_fetch(sdk, identityId);
          console.log("fetched data contract");
          console.log(dataContract);
          identityInfo.textContent = JSON.stringify(dataContract.toJSON(), null, 2);
        } catch (error) {
          console.error("Error fetching contract:", error);
          identityInfo.textContent = `Error fetching contract: ${error}`;
        } finally {
          preloader.style.display = 'none';
        }
      });
    }

    run();
  </script>
</body>

</html>